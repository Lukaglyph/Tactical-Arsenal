<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tactical Arsenal - Standard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Noto+Sans+JP:wght@400;700&display=swap');
        :root { --neon-blue: #00f3ff; --neon-pink: #ff0055; --neon-green: #39ff14; --cyber-dark: #050508; --neon-gold: #ffcc00; --stun-red: #ff3300; }
        * { -webkit-tap-highlight-color: transparent; touch-action: manipulation; user-select: none; }
        body { background-color: var(--cyber-dark); color: #e2e8f0; font-family: 'Noto Sans JP', sans-serif; overflow: hidden; height: 100dvh; margin: 0; display: flex; flex-direction: column; }
        
        .board-grid { display: grid; grid-template-columns: repeat(9, 1fr); gap: 1px; background: rgba(0, 243, 255, 0.2); border: 1px solid #1a1a2e; width: 92vw; height: 92vw; max-width: 70dvh; max-height: 70dvh; margin: 4px auto; }
        .square { background: rgba(10, 10, 20, 0.98); display: flex; align-items: center; justify-content: center; position: relative; }
        .piece { width: 85%; height: 85%; display: flex; align-items: center; justify-content: center; z-index: 10; transition: all 0.2s; position: relative; }
        .piece.p1 { color: var(--neon-blue); filter: drop-shadow(0 0 4px var(--neon-blue)); }
        .piece.p2 { color: var(--neon-pink); filter: drop-shadow(0 0 4px var(--neon-pink)); transform: rotate(180deg); }
        .piece.promoted { color: var(--neon-gold) !important; filter: drop-shadow(0 0 6px var(--neon-gold)) !important; }
        
        .shield-active { outline: 2px solid var(--neon-green); outline-offset: -2px; border-radius: 4px; box-shadow: 0 0 10px var(--neon-green); }
        .stun-active { filter: grayscale(1) brightness(0.5); background: rgba(255, 0, 0, 0.1); }
        .stun-active::after { content: ''; position: absolute; inset: 0; border: 2px solid var(--stun-red); animation: stun-blink 0.5s infinite; border-radius: 4px; }
        
        #unit-hud { 
            position: absolute; top: 45px; left: 50%; transform: translateX(-50%); 
            width: 94%; max-width: 500px; 
            background: rgba(0, 10, 20, 0.9); border: 1px solid var(--neon-blue); 
            padding: 8px 12px; border-radius: 4px; 
            display: none; align-items: center; gap: 10px; z-index: 50; pointer-events: none;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.4);
        }

        .stock-area { display: flex; gap: 4px; padding: 4px; min-height: 40px; background: rgba(255,255,255,0.03); border: 1px dashed rgba(0, 243, 255, 0.2); margin: 2px auto; width: 92vw; max-width: 70dvh; }
        .stock-item { width: 35px; height: 35px; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; border-radius: 4px; position: relative; }
        .highlight { background: rgba(0, 243, 255, 0.25) !important; box-shadow: inset 0 0 12px rgba(0, 243, 255, 0.4); }
        .selected-sq { background: rgba(0, 243, 255, 0.15) !important; outline: 1px inset var(--neon-blue); }
        .screen { position: fixed; inset: 0; z-index: 200; display: flex; flex-direction: column; padding: 20px; background: radial-gradient(circle at top, #1a1a2e 0%, #050508 100%); }
        .mod-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 4px; transition: 0.2s; }
        .mod-btn.selected { background: rgba(0, 243, 255, 0.15); border-color: var(--neon-blue); color: var(--neon-blue); }
    </style>
</head>
<body>

    <div id="mode-screen" class="screen items-center justify-center text-center">
        <h1 class="text-4xl font-black text-cyan-400 mb-2 tracking-tighter italic">TACTICAL ARSENAL</h1>
        <p class="text-gray-500 text-xs mb-12 uppercase tracking-widest">Digital Tactical Board Game</p>
        
        <div class="space-y-6 w-full max-w-xs">
            <button onclick="selectMode('pvp')" class="w-full py-6 border-2 border-cyan-500 text-cyan-400 group hover:bg-cyan-500/10 transition-all">
                <div class="text-xl font-bold">対人戦 (2人用)</div>
                <div class="text-[10px] opacity-60 uppercase">Player vs Player</div>
            </button>
            
            <button onclick="selectMode('pve')" class="w-full py-6 border-2 border-pink-500 text-pink-400 group hover:bg-pink-500/10 transition-all">
                <div class="text-xl font-bold">CPU戦 (1人用)</div>
                <div class="text-[10px] opacity-60 uppercase">Single Player vs AI</div>
            </button>
        </div>
        
        <div class="absolute bottom-10 text-[10px] text-gray-600 font-mono">SYSTEM READY // VERSION 1.2.0</div>
    </div>

    <div id="config-screen" class="screen hidden">
        <header class="mb-4">
            <h1 class="text-xl font-black text-cyan-400">兵装カスタマイズ</h1>
            <div class="mt-2 text-[10px] text-gray-400 flex justify-between uppercase">
                <span>Energy Capacity</span> <span id="cost-text">0 / 12</span>
            </div>
            <div class="h-1 bg-gray-800 mt-1"><div id="cost-bar" class="h-full bg-cyan-500 transition-all" style="width:0%"></div></div>
        </header>
        <main class="flex-1 flex gap-3 overflow-hidden">
            <div class="w-1/3 overflow-y-auto space-y-2" id="unit-list"></div>
            <div class="flex-1 bg-white/5 rounded p-3 overflow-y-auto" id="module-container"></div>
        </main>
        <button onclick="startGame()" id="start-btn" class="mt-4 py-4 bg-cyan-500 text-black font-black tracking-widest uppercase disabled:opacity-30">作戦開始</button>
    </div>

    <div id="game-screen" class="hidden flex flex-col h-full overflow-hidden relative">
        <div class="p-2 flex justify-between items-center bg-black/40 border-b border-cyan-900/30 z-10">
            <div id="turn-display" class="font-black text-cyan-400 text-sm italic tracking-widest uppercase">P1 Phase</div>
            <div id="ai-status" class="text-[8px] text-pink-500 animate-pulse hidden uppercase">AI Thinking...</div>
            <div onclick="location.reload()" class="text-[9px] text-red-600 border border-red-900 px-2 font-bold uppercase cursor-pointer">Abort</div>
        </div>
        <div id="unit-hud">
            <div id="hud-icon" class="text-cyan-400"></div>
            <div class="flex-1">
                <div class="flex justify-between items-start">
                    <div id="hud-name" class="text-[10px] font-black text-cyan-400 uppercase"></div>
                    <div id="hud-status" class="flex gap-1"></div>
                </div>
                <div id="hud-ars-name" class="text-[9px] text-neon-green font-bold"></div>
                <div id="hud-ars-desc" class="text-[8px] text-gray-300 leading-tight"></div>
            </div>
        </div>
        <div id="stock-p2" class="stock-area rotate-180"></div>
        <div class="flex-1 flex items-center justify-center"><div id="board" class="board-grid"></div></div>
        <div id="stock-p1" class="stock-area"></div>
        <div class="h-14 bg-black/80 p-2 overflow-y-auto font-mono text-[9px] text-cyan-700 border-t border-cyan-900/50" id="system-log"></div>
    </div>

    <script>
        const UNITS = { P:'ストライカー', L:'ピアッサー', N:'ジャンパー', S:'ガード', G:'ベテラン', B:'スナイパー', R:'バスター', K:'コア' };
        const VALUES = { P:10, L:20, N:25, S:30, G:35, B:40, R:50, K:10000 };
        const MODULES = {
            none: { name: '標準兵装', icon: 'minus-circle', desc: '追加機能なし。コスト0。', cost: 0 },
            shield: { name: 'シールド', icon: 'shield', desc: '一度だけ攻撃を無効化する。', cost: 1 },
            emp: { name: 'EMP', icon: 'zap', desc: '着地時、周囲8マスの敵を麻痺させる。', cost: 2 },
            booster: { name: 'ブースター', icon: 'wind', desc: '移動後にもう一度行動可能。(B,R不可)', cost: 3 },
            snipe: { name: 'スナイプ', icon: 'target', desc: '歩兵の射程が+1強化される。', cost: 2 },
            gravity: { name: 'グラビティ', icon: 'disc', desc: '着地時、周囲の敵を弾き飛ばす。', cost: 3 }
        };
        const PIECE_ICONS = { P:'chevron-up', L:'arrow-up-to-line', N:'zap', S:'shield', G:'award', B:'crosshair', R:'wind', K:'cpu' };

        let board = Array(9).fill().map(() => Array(9).fill(null));
        let stocks = { 1: {}, 2: {} };
        let selectedUnit = 'P';
        let unitArsenalMapping = { P:'none', L:'none', N:'none', S:'none', G:'none', B:'none', R:'none' };
        let selected = null, selectedStock = null, turn = 1, isVsAI = false, gameOver = false, boosterActive = false;

        function selectMode(m) { isVsAI=(m==='pve'); document.getElementById('mode-screen').classList.add('hidden'); document.getElementById('config-screen').classList.remove('hidden'); initUI(); }
        function initUI() {
            const list = document.getElementById('unit-list'); list.innerHTML = '';
            Object.keys(UNITS).filter(k=>k!=='K').forEach(k => {
                const card = document.createElement('div');
                card.className = `p-2 rounded border-l-2 cursor-pointer ${selectedUnit===k?'bg-cyan-500/10 border-cyan-400':'bg-white/5 border-transparent'}`;
                card.onclick = () => { selectedUnit = k; initUI(); };
                card.innerHTML = `<div class="text-[9px] font-bold text-cyan-400">${UNITS[k]}</div><div class="text-[8px] opacity-40">${MODULES[unitArsenalMapping[k]].name}</div>`;
                list.appendChild(card);
            });
            const container = document.getElementById('module-container'); container.innerHTML = '';
            Object.keys(MODULES).forEach(k => {
                const btn = document.createElement('div');
                btn.className = `mod-btn cursor-pointer mb-2 flex flex-col ${unitArsenalMapping[selectedUnit]===k?'selected':''}`;
                btn.onclick = () => {
                    if (k === 'booster' && (selectedUnit === 'B' || selectedUnit === 'R')) {
                        alert("B(スナイパー)とR(バスター)はブースターを装備できません。");
                        unitArsenalMapping[selectedUnit] = 'none';
                    } else {
                        unitArsenalMapping[selectedUnit] = k;
                    }
                    initUI();
                };
                btn.innerHTML = `<div class="flex items-center gap-2 mb-1"><i data-lucide="${MODULES[k].icon}" class="w-4 h-4"></i><span class="font-bold text-[11px]">${MODULES[k].name}</span></div><div class="text-[9px] opacity-70 leading-tight">${MODULES[k].desc}</div>`;
                container.appendChild(btn);
            });
            updateCost(); lucide.createIcons();
        }
        function updateCost() {
            let total = 0; Object.values(unitArsenalMapping).forEach(m => total += MODULES[m].cost);
            document.getElementById('cost-text').innerText = `${total} / 12`;
            document.getElementById('cost-bar').style.width = `${(total/12)*100}%`;
            document.getElementById('start-btn').disabled = total > 12;
        }
        function startGame() { document.getElementById('config-screen').classList.add('hidden'); document.getElementById('game-screen').classList.remove('hidden'); setupSide(2, 0, 1, 2); setupSide(1, 8, 7, 6); renderBoard(); }
        
        function setupSide(p, r1, r2, rP) {
            ['L','N','S','G','K','G','S','N','L'].forEach((t, c) => {
                const ars = unitArsenalMapping[t] || 'none';
                board[r1][c] = { type: t, p, stun: 0, promoted: false, ars: ars, shield: (ars==='shield') };
            });
            ['B','R'].forEach((t, i) => {
                const col = (p === 1) ? (i === 0 ? 1 : 7) : (i === 0 ? 7 : 1);
                const ars = unitArsenalMapping[t] || 'none';
                board[r2][col] = { type: t, p, stun: 0, promoted: false, ars: ars, shield: (ars==='shield') };
            });
            for(let i=0; i<9; i++) {
                const ars = unitArsenalMapping['P'] || 'none';
                board[rP][i] = { type: 'P', p, stun: 0, promoted: false, ars: ars, shield: (ars==='shield') };
            }
        }

        function renderBoard() {
            const bEl = document.getElementById('board'); bEl.innerHTML = '';
            for(let r=0; r<9; r++) for(let c=0; c<9; c++) {
                const sq = document.createElement('div'); sq.className = 'square';
                if(selected && selected.r === r && selected.c === c) sq.classList.add('selected-sq');
                sq.onclick = () => !gameOver && (turn === 1 || !isVsAI) && handleTap(r, c);
                const p = board[r][c];
                if(p) {
                    const pEl = document.createElement('div');
                    pEl.className = `piece p${p.p} ${p.shield ? 'shield-active' : ''} ${p.promoted ? 'promoted' : ''} ${p.stun > 0 ? 'stun-active' : ''}`;
                    pEl.innerHTML = `<i data-lucide="${PIECE_ICONS[p.type]}"></i>`;
                    sq.appendChild(pEl);
                }
                bEl.appendChild(sq);
            }
            renderStocks(); lucide.createIcons();
        }

        function handleTap(r, c) {
            const targetPiece = board[r][c];
            if (selectedStock) {
                if (!board[r][c]) {
                    board[r][c] = { type: selectedStock.type, p: turn, stun: 0, promoted: false, ars: 'none', shield: false };
                    stocks[turn][selectedStock.type]--; selectedStock = null; hideHUD(); nextTurn();
                }
                return;
            }
            if (selected) {
                if (isValid(selected.r, selected.c, r, c)) {
                    if (targetPiece && targetPiece.p !== turn && targetPiece.shield) {
                        targetPiece.shield = false; log(`Shield Absorbed Attack.`);
                        selected = null; hideHUD(); renderBoard(); nextTurn(); 
                    } else {
                        if (targetPiece && targetPiece.type === 'K') return win(turn);
                        if (targetPiece) stocks[turn][targetPiece.type] = (stocks[turn][targetPiece.type] || 0) + 1;
                        executeMove(selected.r, selected.c, r, c);
                    }
                } else { selected = null; hideHUD(); renderBoard(); }
            } else if (targetPiece && targetPiece.p === turn && targetPiece.stun === 0) {
                selected = {r, c}; showHUD(targetPiece); renderBoard(); highlight(r, c);
            } else {
                hideHUD(); selected = null; renderBoard();
            }
        }

        function executeMove(sr, sc, tr, tc) {
            const p = board[sr][sc];
            board[tr][tc] = p; board[sr][sc] = null;
            if (((p.p === 1 && tr <= 2) || (p.p === 2 && tr >= 6)) && !p.promoted && p.type !== 'K' && p.type !== 'G') {
                p.promoted = true;
            }
            if (p.ars === 'emp') {
                for(let i=-1; i<=1; i++) for(let j=-1; j<=1; j++) {
                    let nr=tr+i, nc=tc+j;
                    if(nr>=0 && nr<9 && nc>=0 && nc<9 && board[nr][nc] && board[nr][nc].p !== turn) board[nr][nc].stun = 2;
                }
            }
            if (p.ars === 'gravity') {
                for(let i=-1; i<=1; i++) for(let j=-1; j<=1; j++) {
                    if(i===0 && j===0) continue;
                    let nr=tr+i, nc=tc+j, fr=nr+i, fc=nc+j;
                    if(nr>=0 && nr<9 && nc>=0 && nc<9 && board[nr][nc] && fr>=0 && fr<9 && fc>=0 && fc<9 && !board[fr][fc]) {
                        board[fr][fc] = board[nr][nc]; board[nr][nc] = null;
                    }
                }
            }
            selected = null; hideHUD();
            if (p.ars === 'booster' && !boosterActive) {
                boosterActive = true; renderBoard();
                if (isVsAI && turn === 2) setTimeout(runAI, 600);
            } else { setTimeout(nextTurn, 100); }
        }

        function isValid(sr, sc, tr, tc) {
            const p = board[sr][sc];
            if (board[tr][tc] && board[tr][tc].p === p.p) return false;
            const dr = tr - sr, dc = tc - sc, s = p.p === 1 ? -1 : 1;
            if (p.ars === 'snipe' && p.type === 'P' && dc === 0 && dr === s * 2) return !board[sr+s][sc];
            if (p.promoted && p.type !== 'R' && p.type !== 'B') return Math.abs(dr) <= 1 && Math.abs(dc) <= 1 && !(dr === -s && Math.abs(dc) === 1);
            const isPathClear = (sr, sc, tr, tc) => { 
                let stepR = Math.sign(tr-sr), stepC = Math.sign(tc-sc), cr = sr+stepR, cc = sc+stepC; 
                while(cr!==tr || cc!==tc) { if(board[cr][cc]) return false; cr+=stepR; cc+=stepC; } return true; 
            };
            switch(p.type) {
                case 'P': return dc === 0 && dr === s;
                case 'N': return dr === s * 2 && Math.abs(dc) === 1;
                case 'L': return dc === 0 && (p.p === 1 ? dr < 0 : dr > 0) && isPathClear(sr, sc, tr, tc);
                case 'R': return (dr === 0 || dc === 0) && isPathClear(sr, sc, tr, tc);
                case 'B': return Math.abs(dr) === Math.abs(dc) && isPathClear(sr, sc, tr, tc);
                case 'S': return (Math.abs(dr) === 1 && Math.abs(dc) === 1) || (dr === s && dc === 0);
                case 'G': return Math.abs(dr) <= 1 && Math.abs(dc) <= 1 && !(dr === -s && Math.abs(dc) === 1);
                case 'K': return Math.abs(dr) <= 1 && Math.abs(dc) <= 1;
                default: return false;
            }
        }

        function renderStocks() {
            [1, 2].forEach(p => {
                const sEl = document.getElementById(`stock-p${p}`); sEl.innerHTML = '';
                Object.entries(stocks[p]).forEach(([type, count]) => {
                    if (count <= 0) return;
                    const item = document.createElement('div');
                    item.className = `stock-item p${p} cursor-pointer`;
                    item.innerHTML = `<i data-lucide="${PIECE_ICONS[type]}"></i><span class="absolute bottom-0 right-0 text-[8px] bg-black px-1">${count}</span>`;
                    item.onclick = (e) => { e.stopPropagation(); if(turn===p) { selected=null; selectedStock={p,type}; renderBoard(); } };
                    sEl.appendChild(item);
                });
            });
        }

        function nextTurn() {
            if(gameOver) return; turn = turn === 1 ? 2 : 1; boosterActive = false;
            document.getElementById('turn-display').innerText = `P${turn} PHASE`;
            document.getElementById('turn-display').style.color = turn === 1 ? 'var(--neon-blue)' : 'var(--neon-pink)';
            board.flat().forEach(p => { if(p && p.p === turn) { if(p.stun > 0) p.stun--; } });
            renderBoard();
            if (isVsAI && turn === 2) { document.getElementById('ai-status').classList.remove('hidden'); setTimeout(runAI, 800); }
        }

        function runAI() {
            if (gameOver) return;
            let moves = [];
            for(let r=0; r<9; r++) for(let c=0; c<9; c++) {
                if(board[r][c] && board[r][c].p === 2 && board[r][c].stun === 0) {
                    for(let tr=0; tr<9; tr++) for(let tc=0; tc<9; tc++) if(isValid(r, c, tr, tc)) moves.push({sr:r, sc:c, tr, tc, score: (board[tr][tc]?VALUES[board[tr][tc].type]*2 : 0) + tr});
                }
            }
            if(moves.length > 0) {
                moves.sort((a,b) => b.score - a.score); const m = moves[0];
                const target = board[m.tr][m.tc];
                if (target && target.p === 1 && target.shield) { target.shield = false; renderBoard(); nextTurn(); }
                else if (target && target.type === 'K') return win(2);
                else { if(target) stocks[2][target.type]=(stocks[2][target.type]||0)+1; executeMove(m.sr, m.sc, m.tr, m.tc); }
            } else { nextTurn(); }
            document.getElementById('ai-status').classList.add('hidden');
        }

        function showHUD(p) {
            const hud = document.getElementById('unit-hud');
            const mod = MODULES[p.ars];
            const statusEl = document.getElementById('hud-status');
            statusEl.innerHTML = '';
            if(p.stun > 0) statusEl.innerHTML += `<span class="bg-red-600 text-[7px] px-1 rounded text-white">STUNNED</span>`;
            if(p.shield) statusEl.innerHTML += `<span class="bg-green-600 text-[7px] px-1 rounded text-white">SHIELD</span>`;
            
            document.getElementById('hud-name').innerText = `${p.promoted ? '強化型 ' : ''}${UNITS[p.type]}`;
            document.getElementById('hud-ars-name').innerText = `Arsenal: ${mod.name}`;
            document.getElementById('hud-ars-desc').innerText = mod.desc;
            hud.style.display = 'flex'; lucide.createIcons();
        }
        function hideHUD() { document.getElementById('unit-hud').style.display = 'none'; }
        function highlight(r, c) { for(let tr=0; tr<9; tr++) for(let tc=0; tc<9; tc++) if(isValid(r, c, tr, tc)) document.getElementById('board').children[tr*9+tc].classList.add('highlight'); }
        function log(m) { const l = document.getElementById('system-log'); l.innerHTML = `<div>> ${m}</div>` + l.innerHTML; }
        function win(w) { gameOver = true; alert(`P${w} VICTORIOUS`); location.reload(); }
    </script>
</body>
</html>
